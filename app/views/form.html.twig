<!DOCTYPE html>
<html>
<head>
	<title>{{ appTitle }}</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" integrity="sha256-iq5ygGJ7021Pi7H5S+QAUXCPUfaBzfqeplbg/KlEssg=" crossorigin="anonymous" />
	<link rel="stylesheet" href="/css/jquery.bootgrid.min.css" />

	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.slim.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js" integrity="sha256-JuQeAGbk9rG/EoRMixuy5X8syzICcvB0dj3KindZkY0=" crossorigin="anonymous"></script>
	<script src="/js/jquery.bootgrid.min.js"></script>

	<style type="text/css">
	#mynetwork {
		height: 700px;
		border: 1px solid lightgray;
	}
</style>

<script type="text/javascript">
	var network,nodes,edges;
	function objectToArray(obj) {
		return Object.keys(obj).map(function (key) {
			obj[key].id = key;
			return obj[key];
		});
	}

	function startNetwork() {
		var container = document.getElementById('mynetwork');
		var  options = {
			nodes: {
				shape: 'dot',
				size: 16,
				brokenImage: '/img/no-image-icon.png'
			},
			physics: {
				forceAtlas2Based: {
					gravitationalConstant: -30,
					centralGravity: 0.004,
				},
				solver: 'forceAtlas2Based',
				timestep: 0.2,
				stabilization: {
					enabled:false,
					iterations:500,
					updateInterval:25
				}
			}
		};
		$.get( '/nodes', function(nodelist) {
			$.get( '/edges', function(edgelist) {
				nodes = new vis.DataSet(nodelist);
				edges = new vis.DataSet(edgelist);
				var data = {
					nodes: nodes,
					edges: edges
				}
				network = new vis.Network(container, data, options);
				options.physics.enabled=true;
				network.setOptions(options);
			});
		});
	}

	function checkImage(url,callback){
		var s = document.createElement("IMG");
		s.src = url
		s.onerror = function(){
			callback(false);
		}
		s.onload = function(){
			callback(true);
		}
	}

	$(function(){
		var socket = io();
		$( ".namecomplete" ).autocomplete({
			source: "/getnodes",
			minLength: 3
		});
		{% if user == "cerichar" %}
		$("#save").click(function(event) {
			event.preventDefault();
			var nodes = objectToArray(network.getPositions());
			nodes.forEach(function(node, index){
				$.post( '/updateNodePos',{"id": node.id, "x": node.x, "y":node.y}, function(res) {
				});
			});
		});

		$("#updateLogins").click(function(event) {
			event.preventDefault();
			$.get( '/nodes', function(nodes) {
				nodes.forEach(function(node, index){
					var firstName = node.label.split(' ').slice(0, -1).join(' ');
					var lastName = node.label.split(' ').slice(-1).join(' ');
					$.get( 'http://assos.utc.fr/nuitfauve/find.php',{ "key": 'nf16enculey', 'prenom': firstName, 'nom': lastName }, function(findData) {
						if(findData){
							checkImage('https://demeter.utc.fr/portal/pls/portal30/portal30.get_photo_utilisateur?username='+findData.login, (utcData)=> {
								if(utcData===true)
									$.get( '/updateLogin',{"id": node.id, "login": findData.login}, function(res) {});
							});
						}
					});
				});
			});
		});
		{% endif %}
		$( "#add" ).click(function(event) {
			event.preventDefault();
			var fromTxt = $("#from").val().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
			var toTxt = $("#to").val().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
			if(fromTxt=="" || toTxt=="")
				return;
			$.post( '/getNodeId',{ who: fromTxt}, function (data){
				fromId=data.id;
				$.post( '/getNodeId',{ who: toTxt}, function (data){
					toId=data.id;
					$.post( '/add',{ from: fromId, to: toId }, function(data) {
						$("#table").bootgrid("append",[{ "id":data.id, "parent":fromTxt, "child":toTxt, "creator":"{{user}}", "status":1 }]);
						$("#to").val("");
					});
				});
			});
		});

		var table = $("#table").bootgrid({
			formatters: {
				"commands": function(column, row)
				{
					if(row.creator === "{{user}}" || "{{user}}" === "cerichar")
						return "<button class=\"btn btn-danger delete\" id=\"add\" data-row-id=\"" + row.id + "\">X</button>";
					else
						return "";
				}
			}
		}).on("loaded.rs.jquery.bootgrid", function()
		{
			table.find(".delete").on("click", function(e)
			{	
				let id = $(this).data("row-id");
				$.get( '/delete',{ "id": id }, function(data) {
					$("#table").bootgrid("remove",[id]);
				});
			});
		});;
		$("#graphFindBtn").click(function(event) {
			event.preventDefault();
			var txt = $("#graphSearchInput").val().normalize('NFD').replace(/[\u0300-\u036f]/g, "");
			if(txt=="")
				return;
			$.post( '/getNodeId',{ who: txt, shouldcreate: false}, function (data){
				if(data.id!==null)
					network.selectNodes([data.id]);network.fit({nodes:[data.id]});
			});
		});
		startNetwork();
		socket.on('edge add', edges.add);
		socket.on('node add', nodes.add);
	});	
</script>
</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-10 text-center">
				<h1 class="display-4">
					Genealog'Utc
				</h2>
				<p class="lead">
					Entrez les noms de vos parrains/marraines/fillots/fillottes, officiels/adopt√©s/disparus/chelous afin de contruire un joli graph !
				</p>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col-md-5">
			<form class="form-horizontal" role="form">
				<div class="form-group">
					<label for="from" class="col-sm-2 control-label">
						Nom du parrain/marraine
					</label>
					<div class="col-sm-9">
						<input class="form-control namecomplete" id="from" name="from" />
					</div>
				</div>
				<div class="form-group">
					<label for="to" class="col-sm-2 control-label">
						Nom du fillot(te)
					</label>
					<div class="col-sm-9">
						<input class="form-control namecomplete" id="to" name="to" />
					</div>
				</div>
				<div class="form-group">
					<div class="col-sm-offset-2 col-sm-9">
						<button class="btn btn-success" id="add" >
							Ajouter
						</button>
					</div>
				</div>
			</form>
			<table class="table table-striped table-condensed table-hover" id="table">
				<thead>
					<tr>
						<th data-column-id="id" data-identifier="true" data-type="numeric" data-visible="false">
							Id
						</th>
						<th data-column-id="parent" data-order="asc">
							Parrain/Marraine
						</th>
						<th data-column-id="child" data-order="asc">
							Fillot(te)
						</th>
						<th data-column-id="commands" data-formatter="commands" data-sortable="false">
							Supprimer
						</th><th data-column-id="creator" data-visible="false">
							Createur
						</th>
					</tr>
				</thead>
				<tbody>
					{% for link in links %}
					<tr id="tr{{link.id}}">
						<td>{{link.id}}</td>
						<td>{{link.parent.label}}</td>
						<td>{{link.child.label}}</td>
						<td>
							<button class="btn btn-danger delete" id="add" linkid="{{link.id}}" >
								X
							</button>
						</td>
						<td>{{link.creator}}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<h2>Graph <a class="btn btn-primary" href="/view">(cliquez ici pour le voir en grand)</a></h2>
		<div>Utilisez la molette pour zoomer</div>
		<div class="col-md-6">
			<form>
				<div class="form-group">
					<label for="graphSearchInput">Recherche</label>
					<input class="form-control namecomplete" id="graphSearchInput"/>
					<button class="btn btn-primary" id="graphFindBtn" >
						Rechercher
					</button>
				</div>
			</form>
		</div>
		<div class="col-md-6" id="mynetwork">
		</div>
		{% if user == "cerichar" %}<button class="btn btn-primary" id="save" >save positions</button><button class="btn btn-primary" id="updateLogins" >Update Logins</button>{% endif %}
	</div>
</div>
</body>
</html>